<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="../js/header.js"></script>
<script src="../js/util.js"></script>
<script src="../js/bootstrap-rating.min.js"></script>
<link href="../css/bootstrap-rating.css" rel="stylesheet">
<title>NurseHub</title>
<script>
var color = ['','btn-primary','btn-success','btn-info','btn-warning','btn-danger'];
var modalBtn = "";
var whichWeek = "thisWeek";
var gMinTimeLimit=0;
var gMaxTimeLimit=1000;

function loadTimeLimit(){
	var res = getJson("/admin/loadTimeLimit");
	gMinTimeLimit = res.minTime;
	gMaxTimeLimit = res.maxTime;
}

function thisWeek(){
	$("#thisDiv").show();
	$("#nextDiv").hide();
	whichWeek = "thisWeek";
}
function nextWeek(){
	$("#thisDiv").hide();
	$("#nextDiv").show();
	whichWeek = "nextWeek";
}
function showDemand(week,which){
	var hide = "."+which +" .demand";
	$(hide).hide();
	var show = hide + "." + week;
	$(show).show();
}

function loadRosterReport(){
	var res= getJson("/admin/loadRosterReport");
	
	var thisArr = new Array();
	var nextArr = new Array();
	var idx=0;
	for(i in res[0]){
		thisArr[idx] = res[0][i];
		idx = idx+1;
	}
	idx = 0;
	for(i in res[1]){
		nextArr[idx] = res[1][i];
		idx = idx+1;
	}
	
	if(thisArr[0]==true){
		$(".thisWeek .timeLimitOk").text(" √");
		$(".thisWeek .timeLimitOk").css({"color":"green","font-size":"150%"});
	}else{
		$(".thisWeek .timeLimitOk").text(" ×");
		$(".thisWeek .timeLimitOk").css({"color":"red","font-size":"150%"});
	}
	if(thisArr[1]==true){
		$(".thisWeek .demandOk").text(" √");
		$(".thisWeek .demandOk").css({"color":"green","font-size":"150%"});
	}else{
		$(".thisWeek .demandOk").text(" ×");
		$(".thisWeek .demandOk").css({"color":"red","font-size":"150%"});
	}
	if(nextArr[0]==true){
		$(".nextWeek .timeLimitOk").text(" √");
		$(".nextWeek .timeLimitOk").css({"color":"green","font-size":"150%"});
	}else{
		$(".nextWeek .timeLimitOk").text(" ×");
		$(".nextWeek .timeLimitOk").css({"color":"red","font-size":"150%"});
	}
	if(nextArr[1]==true){
		$(".nextWeek .demandOk").text(" √");
		$(".nextWeek .demandOk").css({"color":"green","font-size":"150%"});
	}else{
		$(".nextWeek .demandOk").text(" ×");
		$(".nextWeek .demandOk").css({"color":"red","font-size":"150%"});
	}
	
	$(".thisWeek .compScore").val(thisArr[2]);
	$(".nextWeek .compScore").val(nextArr[2]);
	
	for(i=0;i<3;i++){
		$(".thisWeek .prefTd").eq(i).val(thisArr[i+3]);
		$(".nextWeek .prefTd").eq(i).val(nextArr[i+3]);
	}
	for(i=6;i<9;i++){
		$(".thisWeek .prefTd").eq(i-3).val(thisArr[i+3]);
		$(".nextWeek .prefTd").eq(i-3).val(nextArr[i+3]);
	}
	for(i=3;i<6;i++){
		$(".thisWeek .prefTd").eq(i+3).text(thisArr[i+3]);
		$(".nextWeek .prefTd").eq(i+3).text(nextArr[i+3]);
	}
	
	var thisDemands = thisArr[12];
	var nextDemands = nextArr[12];
	
	
	var contShift = "";
	var colorShift = ['','primary','success','info','warning','danger'];
	var levelName = ["N0:Nurse","N1:Nurse Practitioner","N2:Nurse-in-charge","N3:Associate Professor of Nursing","N4:Professor of Nursing"];
	for(var sh in thisDemands[0]){
		contShift = contShift + "<tr><td rowspan='10' style='width:15%' class=" +colorShift[strNum(thisDemands[i][sh].name)] + "><b>" + thisDemands[i][sh].name +"</b></td>";
		for(var idxL=0;idxL<5;idxL++){
			if(idxL!=0){
				contShift += "<tr>"
			}
			contShift = contShift + "<td class='info' colspan='9'><b>" + levelName[idxL] + "</b></td></tr>";
			contShift = contShift + "<tr><td class='success'>Arranged</td>"
			for(var idxD=0;idxD<7;idxD++){
				var arranged = thisDemands[idxD][sh]["lv"+(idxL+1)];
				var demand = thisDemands[idxD][sh]["lv"+(idxL+1)+"rec"];
				var pre="<td>";
				if(arranged < demand){
					pre = "<td style='color:red'>";
				}else if(arranged > demand){
					pre = "<td style='color:blue'>";
				}
				contShift = contShift + pre + arranged + "</td>";
			}
			contShift = contShift + "<td>" + thisDemands[0][sh]["lv"+(idxL+1)+"rec"] + "</td></tr>";
		}
	}
	 
	$("#thisDemandTb").html(contShift);
	
	contShift = "";
	for(var sh in nextDemands[0]){
		contShift = contShift + "<tr><td rowspan='10' style='width:15%' class=" +colorShift[strNum(nextDemands[i][sh].name)] + "><b>" + nextDemands[i][sh].name +"</b></td>";
		for(var idxL=0;idxL<5;idxL++){
			if(idxL!=0){
				contShift += "<tr>"
			}
			contShift = contShift + "<td class='info' colspan='9'><b>" + levelName[idxL] + "</b></td></tr>";
			contShift = contShift + "<tr><td class='warning'>Arranged</td>"
			for(var idxD=0;idxD<7;idxD++){
				var arranged = nextDemands[idxD][sh]["lv"+(idxL+1)];
				var demand = nextDemands[idxD][sh]["lv"+(idxL+1)+"rec"];
				var pre="<td>";
				if(arranged < demand){
					pre = "<td style='color:red'>";
				}else if(arranged > demand){
					pre = "<td style='color:blue'>";
				}
				contShift = contShift + pre + arranged + "</td>";
			}
			contShift = contShift + "<td>" + nextDemands[0][sh]["lv"+(idxL+1)+"rec"] + "</td></tr>";
		}
	}
	 
	$("#nextDemandTb").html(contShift);
		
}


function showHead(){
	var date = new Date();
	var day = date.getDay();
	if(day==0){
		day = 7;
	}
	date.setDate(date.getDate()-day);
	for(i=0;i<14;i++){
		date.setDate(date.getDate()+1);
		var str = showDay(date.getDay()) + "(" + (date.getMonth()+1) + "/" + date.getDate() +")";
		$(".day").eq(i).text(str);
		$(".dayShift").eq(i).text(str);
	}
}

function strNum(str){
	if(str==null || str==""){
		return 0;
	}
	var len = str.length;
	var num=0;
	for(var idx=0;idx<len;idx++){
		num = num + str.charCodeAt(idx);
	}
	return num%6;
}

function getRoster(week){
	var url = "/getRoster/"+week;
	return getJson(url);
}

function getRosterByLevel(week,level){
	var url = "/getRoster/"+week + "/" + level;
	return getJson(url);
}

function fillerHelper(week){
	var levelName = ["N0:Nurse","N1:Nurse Practitioner","N2:Nurse-in-charge","N3:Associate Professor of Nursing","N4:Professor of Nursing"];
	var cont = "";
	var shiftRoster =new Object();
	for(var lv=1;lv<=5;lv++){
		var ros1 = getRosterByLevel(week,lv);
		cont = cont + "<tr><td colspan='9' class='info'><b>"+levelName[lv-1]+"</b></td></tr>"

		for(i in ros1){
			//get shift roster
			if(shiftRoster[ros1[i].monShift] == undefined){
				shiftRoster[ros1[i].monShift] = new Array();
				for(var j=0;j<7;j++){
					shiftRoster[ros1[i].monShift][j] = new Array();
					for(var k=0;k<5;k++){
						shiftRoster[ros1[i].monShift][j][k]="";
					}
				}
				
				shiftRoster[ros1[i].monShift][0][lv-1] = "<div>"+ros1[i].nickName + "</div>";
				
			}else{
				shiftRoster[ros1[i].monShift][0][lv-1] += "<div>"+ros1[i].nickName + "</div>";
			}
			//tue
			if(shiftRoster[ros1[i].tueShift] == undefined){
				shiftRoster[ros1[i].tueShift] = new Array();
				for(var j=0;j<7;j++){
					shiftRoster[ros1[i].tueShift][j] = new Array();
					for(var k=0;k<5;k++){
						shiftRoster[ros1[i].tueShift][j][k]="";
					}
				}
				shiftRoster[ros1[i].tueShift][1][lv-1] = "<div>"+ros1[i].nickName + "</div>";
			}else{
				shiftRoster[ros1[i].tueShift][1][lv-1] += "<div>"+ros1[i].nickName + "</div>";
			}
			//wed
			if(shiftRoster[ros1[i].wedShift] == undefined){
				shiftRoster[ros1[i].wedShift] = new Array();
				for(var j=0;j<7;j++){
					shiftRoster[ros1[i].wedShift][j] = new Array();
					for(var k=0;k<5;k++){
						shiftRoster[ros1[i].wedShift][j][k]="";
					}
				}
				shiftRoster[ros1[i].wedShift][2][lv-1] = "<div>"+ros1[i].nickName + "</div>";
			}else{
				shiftRoster[ros1[i].wedShift][2][lv-1] += "<div>"+ros1[i].nickName + "</div>";
			}
			//thu
			if(shiftRoster[ros1[i].thuShift] == undefined){
				shiftRoster[ros1[i].thuShift] = new Array();
				for(var j=0;j<7;j++){
					shiftRoster[ros1[i].thuShift][j] = new Array();
					for(var k=0;k<5;k++){
						shiftRoster[ros1[i].thuShift][j][k]="";
					}
				}
				shiftRoster[ros1[i].thuShift][3][lv-1] = "<div>"+ros1[i].nickName + "</div>";
			}else{
				shiftRoster[ros1[i].thuShift][3][lv-1] += "<div>"+ros1[i].nickName + "</div>";
			}
			//fri
			if(shiftRoster[ros1[i].friShift] == undefined){
				shiftRoster[ros1[i].friShift] = new Array();
				for(var j=0;j<7;j++){
					shiftRoster[ros1[i].friShift][j] = new Array();
					for(var k=0;k<5;k++){
						shiftRoster[ros1[i].friShift][j][k]="";
					}
				}
				shiftRoster[ros1[i].friShift][4][lv-1] = "<div>"+ros1[i].nickName + "</div>";
			}else{
				shiftRoster[ros1[i].friShift][4][lv-1] += "<div>"+ros1[i].nickName + "</div>";
			}
			//sat
			if(shiftRoster[ros1[i].satShift] == undefined){
				shiftRoster[ros1[i].satShift] = new Array();
				for(var j=0;j<7;j++){
					shiftRoster[ros1[i].satShift][j] = new Array();
					for(var k=0;k<5;k++){
						shiftRoster[ros1[i].satShift][j][k]="";
					}
				}
				shiftRoster[ros1[i].satShift][5][lv-1] = "<div>"+ros1[i].nickName + "</div>";
			}else{
				shiftRoster[ros1[i].satShift][5][lv-1] += "<div>"+ros1[i].nickName + "</div>";
			}
			//sun
			if(shiftRoster[ros1[i].sunShift] == undefined){
				shiftRoster[ros1[i].sunShift] = new Array();
				for(var j=0;j<7;j++){
					shiftRoster[ros1[i].sunShift][j] = new Array();
					for(var k=0;k<5;k++){
						shiftRoster[ros1[i].sunShift][j][k]="";
					}
				}
				shiftRoster[ros1[i].sunShift][6][lv-1] = "<div>"+ros1[i].nickName + "</div>";
			}else{
				shiftRoster[ros1[i].sunShift][6][lv-1] += "<div>"+ros1[i].nickName + "</div>";
			}
			
			
			//fill roster
			cont = cont + "<tr>";
			cont = cont + "<th>" +ros1[i].nickName + "</th>";
			for (j in ros1[i]){
				var preStr ="";
				var gUserId;
				if(j=="monId" || j=="tueId" || j=="wedId" || j=="thuId"
					|| j=="friId" || j=="satId" || j=="sunId"){
					if(j=="monId"){cont = cont + "<td>"}
					preStr = "<input type='text' class='hide' name='" 
						+ j + "' value='" +ros1[i][j] + "' ";

					cont = cont + preStr + ">";
					if(j=="sunId"){
						cont = cont + "<input type='text' class='hide' name='userId'value='"
						+ gUserId + "'></td>";}
				}else if(j=="userId"){
					gUserId = ros1[i][j];
				}else if(j=="userName"){
				//	preStr = "<td><input type='button' class='btn' name='" + j + "' value='" +ros1[i].nickName + "' ";
				//	cont = cont + preStr + "></td>";
				}else if(j=="nickName"){
				}else if(j=="totalTime"){
					var total = ros1[i][j];
					if(total > gMaxTimeLimit || total < gMinTimeLimit){
						cont = cont + "<td style='color:red'>" + total + "</td>";
					}else{
						cont = cont + "<td>" + total + "</td>";
					}
				}else{
					preStr = "<td><input type='button' class='btn " + color[strNum(ros1[i][j])] + "' name='" + j + "' value='" +ros1[i][j] 
					+ "' onclick='modalBtn=$(this)' data-toggle=\"modal\" data-target=\"#myModal\" ";
				cont = cont + preStr + "></td>";
				}
			}
			cont = cont + "</tr>";

		}
	}
	
	return cont;
}
function fillRoster(){
	
	$("#thisTbody").html(fillerHelper(1));
	$("#nextTbody").html(fillerHelper(2));
	
	$(".hide").hide();
}


function setModal(){
	var res= getJson("/admin/loadShiftType");
	var cont = "";
	for(i in res){
		if(res[i].used==true){
			cont = cont + "<button class='btn btn-block " + "" + color[strNum(res[i].name)]
				+ "' onclick=\" changeShift('" + res[i].id + "','" + res[i].name + "','"
				+ color[strNum(res[i].name)] + "') \">" + res[i].name + "</button>";
		}
	}
	$(".modal-body").html(cont);
}

function changeShift(id,name,color){
	var tr = modalBtn.parent().parent();
	var raw = modalBtn.attr("name");
	if(raw.indexOf("mon")>-1){
		tr.find(".hide").eq(0).attr("value",id);
	}else if(raw.indexOf("tue")>-1){
		tr.find(".hide").eq(1).attr("value",id);
	}else if(raw.indexOf("wed")>-1){
		tr.find(".hide").eq(2).attr("value",id);
	}else if(raw.indexOf("thu")>-1){
		tr.find(".hide").eq(3).attr("value",id);
	}else if(raw.indexOf("fri")>-1){
		tr.find(".hide").eq(4).attr("value",id);
	}else if(raw.indexOf("sat")>-1){
		tr.find(".hide").eq(5).attr("value",id);
	}else if(raw.indexOf("sun")>-1){
		tr.find(".hide").eq(6).attr("value",id);
	}
	modalBtn.attr("value",name);
	modalBtn.attr("class","btn " + color);
	sendJson("/admin/updateRosterById/" + whichWeek ,jsonify(tr));
	window.location.href="roster.html?whichWeek="+whichWeek;
}

function shiftRoster(){
	var res= getJson("/admin/shiftRoster");
	window.location.href="roster.html";
}

function init(){
	loadTimeLimit();
	whichWeek = getUrlParam("whichWeek");
	if(whichWeek=="thisWeek"){
		thisWeek();
	}else{
		whichWeek = "nextWeek";
		nextWeek();
	}
	
	loadRosterReport();
	showHead();
	fillRoster();
	setModal();
}


</script>
</head>
<body>
<a id="top"></a>
 <nav class="navbar navbar-default" role="navigation">
 	<div class="container-fluid">
 	<div class="navbar-header">
        <a class="navbar-brand" href="/admin/notice.html">NurseHub</a>
    </div>
    <div>
        <ul class="nav navbar-nav">
            <li><a href="notice.html">Notice</a></li>
            <li><a href="strategy.html">Strategy</a></li>
            <li class="active"><a href="roster.html">Roster</a></li>
            <li><a href="approval.html">Approval</a></li>
            <li><a href="staff.html">Staff</a></li>
        </ul>
    </div>
    <div style="text-align:right">
    	<p id="welcome"></p>
    	<a href="/login/quit">quit</a>
    </div>
	</div>
 </nav>
 
 <div class="row">
	<div class="col-xs-2 col-md-1">
		<ul class="nav nav-pills nav-stacked"  data-toggle="buttons">
			<li><a href="#" onclick="window.location.href='rosterNextWeek.html'">Roster Next Week</a></li>
			<li><a href="#" onclick="nextWeek()">Next Week</a></li>
			<li><a href="#" onclick="thisWeek()">This Week</a></li>
			<li><a href="#" onclick="shiftRoster()">Shift Roster</a></li>
		</ul>
	</div>
	
	<div class="col-xs-10 col-md-11">
	<div id="thisDiv" class="thisWeek">
		<div class="panel panel-primary">
		    
		    <div class="panel-heading">
		        <h3 class="panel-title">Report This Week</h3>
		    </div>
		    <div class="panel-body">
		    
		    	<table class="table">
				  <caption>
				  	<div><b>Meet Time Limit:<span class="timeLimitOk"></span></b></div>
				  	<div><b>Meet Shift Demand:<span class="demandOk"></span></b></div>
				  	<div><b>Comprehensive Score:</b>
				  		<input type='hidden' class='rating compScore' data-readonly data-fractions='2'/>
				  	</div>
				  </caption>
				  <thead>
				    <tr>
				      <th></th>
				      <th>Min</th>
				      <th>Avg</th>
				      <th>Max</th>
				    </tr>
				  </thead>
				  <tbody >
				    <tr class="success">
				      <td>ShiftPref</td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				    </tr>
				    <tr class="warning">
				      <td>WorkdayPref</td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				    </tr>
				    <tr class="danger">
				      <td>WorkTime(h)</td>
				      <td class="prefTd"></td>
				      <td class="prefTd"></td>
				      <td class="prefTd"></td>
				    </tr>
				</tbody>
				</table>
				
				
				<table class="table table-striped">
				  <thead>
				  <tr>
				  	<th>Shift</th>
				  	<th></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				  	<th>Demand</th>
				  </tr>
				  </thead>
				  <tbody id="thisDemandTb" ></tbody>
				</table>
		    </div>
		</div>
		
		<div class="panel panel-success">
		    <div class="panel-heading">
		        <h3 class="panel-title">Roster This Week</h3>
		    </div>
		    <div class="panel-body">
		    	<table id="tbThisWeek" class="table table-striped">
				  <thead>
				    <tr>
				      <th>UserName</th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th>Hours</th>
				    </tr>
				  </thead>
				  <tbody id="thisTbody"></tbody>
				</table>
		    </div>
		</div>
	</div>
	
	
	<!-- next week -->
	
	<div id="nextDiv" class="nextWeek">
		<div class="panel panel-info">
		    <div class="panel-heading">
		        <h3 class="panel-title">Report Next Week</h3>
		    </div>
		    <div class="panel-body">
		    	
		    	<table class="table">
				  <caption>
				  	<div><b>Meet Time Limit:<span class="timeLimitOk"></span></b></div>
				  	<div><b>Meet Shift Demand:<span class="demandOk"></span></b></div>
				  	<div><b>Comprehensive Score:</b>
				  		<input type='hidden' class='rating compScore' data-readonly data-fractions='2'/>
				  	</div>
				  </caption>
				  <thead>
				    <tr>
				      <th></th>
				      <th>Min</th>
				      <th>Avg</th>
				      <th>Max</th>
				    </tr>
				  </thead>
				  <tbody >
				    <tr class="success">
				      <td>ShiftPref</td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				    </tr>
				    <tr class="warning">
				      <td>WorkdayPref</td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				      <td><input type='hidden' class='rating prefTd' data-readonly data-fractions='2'/></td>
				    </tr>
				    <tr class="danger">
				      <td>WorkTime(h)</td>
				      <td class="prefTd"></td>
				      <td class="prefTd"></td>
				      <td class="prefTd"></td>
				    </tr>
				</tbody>
				</table>
				
				
				<table class="table table-striped">
				  <thead>
				  <tr>
				  	<th>Shift</th>
				  	<th></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				    <th class="dayShift"></th>
				  	<th>Demand</th>
				  </tr>
				  </thead>
				  <tbody id="nextDemandTb" ></tbody>
				</table>
		    </div>
		</div>
		
		<div class="panel panel-warning" >
			
		    <div class="panel-heading">
		        <h3 class="panel-title">Roster Next Week</h3>
		    </div>
		    <div class="panel-body">
		    	<table id="tbNextWeek"  class="table table-striped">
				  <thead>
				    <tr>
				      <th>UserName</th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th class="day"></th>
				      <th>Hours</th>
				    </tr>
				  </thead>
				  <tbody id="nextTbody"> </tbody>
				</table>
		    </div>
		</div>
		
		
		
	<!-- end -->	
	</div>
	</div>
	
	<!-- Modal -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-header">
	                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	            </div>
	            <div class="modal-body"></div>
	        </div><!-- /.modal-content -->
	    </div><!-- /.modal -->
	</div>
</div>
<div style="text-align:right"><button class="btn btn-primary" onclick="window.location.hash='#top'">TOP</button></div>

<script>
init();
$("#welcome").text("welcome " + checkLogin() );
$("td:not(.info),th").addClass("text-center");
</script>
			
</body>
</html>